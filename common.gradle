// Define project properties
ext {
	serviceName = envVarsProps.SERVICE_NAME_ENV_VAR
	productRepository = "${serviceName}/${productName}"
	productVersion = manifestVersion()
	productK8ShelmChartsFolder = "k8s/helm/charts"
	productionBranchName = envVarsProps.PRODUCTION_BRANCH_NAME_ENV_VAR
	stagingBranchName = envVarsProps.STAGING_BRANCH_NAME_ENV_VAR
	dockerFilePath = "./${-> envVarsProps.JENKINS_SLAVE_K8S_COMMON_SUB_MODULE_NAME}/Dockerfile"
}

//
// Works with org.ajoberstar.grgit plugin
//

// Make prints in tests visible
test {
	systemProperties = System.properties

	// Setup additional environment variables
	environment.put("ECHOBE_SERVICE_ENDPOINT_NAMESPACE",manifestNamespace())

	outputs.upToDateWhen {false}

	testLogging {
		showStandardStreams = true
	}
}

// Returns the current git branch name
def obtainCurrentBranchName() {
	return grgit.branch.current.name
}

// Builds a proper version name
def manifestVersion() {
	def currentBranchName = obtainCurrentBranchName()
	return "${version}-${currentBranchName}"
}

// Construct an applicable namespace to be used by the Helm Chart
def manifestNamespace() {
//	def details = versionDetails()
//	def namespace = details.branchName 
	def namespace = "tiran" 

	// If we are on the production or staging branches return the regular name ($serviceName), else return the branch namne itself
	if (namespace == "${productionBranchName}" || namespace == "${stagingBranchName}") {
		namespace = serviceName
	}
	
	return namespace
}
